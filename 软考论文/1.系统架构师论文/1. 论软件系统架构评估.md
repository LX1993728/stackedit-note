&emsp;2018年2月，我参加了某市智慧城市平台项目的研发，我在项目中承担架构设计师的职务，主要负责系统的技术选型和架构设计。该项目的主要目的是经过多种渠道获取该市各种突发事件和各部门数据；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高办公效率。本文以智慧应急系统为例，论述了软件系统的架构评估。**首先分析了架构评估所普遍关注的质量属性并阐述了其性能、可用性、可修改性和安全性的具体含**义。整个系统采用面向微服务的架构设计方法。**在架构设计完成后，对SA评估采用了基于场景的评估方式中的体系结构权衡分析法ATAM，并详细描述了其评估过程，项目评估小组经过对项目的风险点、敏感点和权衡点的讨论后生成了质量效应树**。于2019年3月交付至今统已稳定运行3年多，从而验证了该项目采用ATAM架构评估保证了系统的顺利完成。
&emsp;随着互联网的崛起，某市响应政府的政策和号召，为了解决该城市中突发事件汇报不及时、上呈下达效率慢时间长、流程繁琐以及该市建设中不合理的隐匿问题以便更好的为人民服务；参考国外智能化城市建设的优势，决定发起智慧城市的项目。2018年1月，我司竞标该项目成功并承担了该市智慧城市项目的开发工作。该项目的主要目的是经过多种渠道获取该市各种事件信息（安保事故、消防事故、交通事故、地震、洪涝灾害等突发事件）和数据（主要是政府各职能部门如林业局，公安局，消防大队，具体涉及高铁、机场、林场、水库、公交、红绿灯、摄像头等相关设备的数据）；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高政府办公的速度，更快速更高效的解决突发事件。
&emsp;系统在整体架构上采用了面向微服务的架构设计方法。架构风格采用B/A/S, 前端采用VUE/Android/IOS进行开发，后台采用开发方便的Springboot在Linux服务器上运行，图片文件采用FDFS分布式存储并使用了RAID5冗余磁盘阵列，缓存采用Redis Cluster集群，数据存储采用ShardingJDBC中间件+MySQL，消息队列采用SpringCloud Stream + kafka集群。通过将系统拆分为多个子模块，各个子模块在构建上使用服务进行封装，它们之间通过RPC或消息进行通信。通过对客户需求进行分析，我将该系统拆分为部委前置模块（对接各职能部门系统并接收指令），上报系统（用于接收来自网格员APP或公众号的上报数据），指挥调度中心（负责接收并分析处理所有处理过的流量）。下面介绍系统架构评估的重要属性。
&emsp;**架构评估是软件开发过程中的重要环节，在软件架构评估中的质量属性有性能、可靠性、可用性、安全性、可修改性、可变性、互操作性和功能性。其中性能、可用性、安全性、可修改性这四个属性是质量效应树的重要组成部分。性能是指系统的响应能力，即经过多长时间对事件做出响应。可用性是指系统能够正常运行的比例，经常用两次故障之间的时间长度或在出现故障时系统能够恢复正常的速度来表示。可修改性是指能够快速的以较高的性能价格比对系统进行变更的能力。安全性是指系统能够为合法用户提供服务的同时能够阻止非授权用户使用的企图或拒绝服务的能力**。
&emsp;**常用的架构评估方法有：基于问卷的调查评估方式、基于场景的评估方式和基于度量的评估方式。基于问卷调查的评估方式是由多个评估专家通过调查问卷的方式回答问卷中的问题，对多个评估结果进行综合，最后得到最终结果。其评价具有主观性不太适合本项目。基于度量的评价方式虽然评价比较客观，但是需要评估者对系统的架构有精确的了解，也不太适合本项目。而基于场景的评估要求评估者对系统中等了解，评价比较主观，故项目采用了基于场景的评估方式。基于场景的评估的方式又分为架构权衡分析法ATAM，软件架构分析法SAAM和成本效益分析法CBAM。本项目中根据不同的质量属性使用了ATAM作为系统架构评估的方法**。
&emsp;**在使用ATAM进行架构评估时，我们根据项目需要成立了项目评估小组。其主要成员包括：评估小组负责人、项目决策者、架构设计师、用户、开发人员、测试人员、系统部署人员等项目干系人。我在这里的身份是项目评估小组负责人和首席架构师。架构的评估经历了描述和介绍阶段、调查和分析阶段、测试阶段和报告阶段四个阶段。下面我从四个阶段进行介绍**。
&emsp;<font color="red">**在描述和介绍阶段**</font>，由于项目中评估成员有部分人员对ATAM并不熟悉，我首先介绍ATAM的方法，它是一种基于场景的软件架构评估方法，对系统的多个质量属性基于场景进行评估。通过评估确认系统存在的风险，并检查各自的非功能性需求是否满足需求。客户也阐述了系统的目的和开发动机，项目是为了通过获取紧急突发事件和各职能部门的数据从而进行及时决策以及通过数据挖掘找出隐藏待改善的问题。客户关注系统的性能、可用性以及可修改性以及是否能快速可靠的处理大量紧急事件。最后作为架构设计师的我描述了系统将要采用的微服务架构，并将系统进行了拆分，并讲解了各个子模块的功能，初步决定系统服务端在Linux下使用Java语言采用Springboot框架进行开发。
&emsp;<font color="red">**在调查分析阶段**</font>，不同的需求方基于各自的考虑都提出了各自的要求。其中客户方提出：系统要保证可用性，特别是市内出现紧急事件时，系统发生的故障必须在1分钟内恢复，此优先级最高；在百万并发级别下，系统的响应延迟不超过1秒，此优先级较高；系统可以对第三方产品进行修改替换以及扩展，此修改工作必须在2人天内完成，以便应对后续的政策变化；系统对上报事件以及数据不能遗漏或丢失，否则可能会导致事故不能被及时发现。在指挥中心下发指令时要保证相对的安全（不能被截获、篡改）。经过总结我们获得了系统的质量效用树如下：
&emsp;针对这些场景我们分析了项目开发过程中的风险点、敏感点和权衡点。经过分析，该项目中存在以下风险点：如果紧急事件上报出现事件遗漏将导致事故不能及时处理；与各职能部门的系统对接过程中如果出现数据丢失将会影响指挥中心的分析结果。敏感点有用户的加密级别、第三方产品的替换。权衡点有：指令的加密强度会提升其安全性，同时带来系统性能的下降，改变指令的加密强度会对安全性和性能都会产生影响。
&emsp;<font color="red">**在测试阶段**</font>，经过评估小组集体讨论，确定了不同场景的优先级如下：系统的可用性最高，性能其次，可修改性和安全性的优先级较低。在保证系统可用性方面，指挥中心的服务部分采用多副本多机房部署。缓存、消息中间件都采用分布式集群部署、数据库采用分库分表和主从复制技术。在性能方面采用服务间负载均衡根据响应延迟决定负载到哪个机器上的服务副本，缓存采用Redis Cluster集群机制灵活的将指定数量的slot分布在不同的机器并进行master-slave读写分离，消息中间件采用kafka这种将每个topic的partition分为多个主从副本来提升性能。在信息安全性方面借鉴PGP协议利用私钥对摘要加密生成数字签名以及数字信封的技术来提升保密性、完整性。在数据安全方面采用备份（全量、增量、差量）备份机制、使用RAID5磁盘冗余阵列、以及多异地容灾来保证数据安全。
&emsp;<font color="red">**最后形成评估报告**</font>，**经过对架构的评估，确定了系统的风险点、非风险点、敏感点、权衡点，最后以文档的形式呈现。其内容包括：架构分析方法文档、架构的不同场景及各自的优先级、质量效应树、风险点决策、非风险点决策以及每次的会议评估记录**。
&emsp;该项目于2019年3月完工，系统上线后，没有出现大的故障。对该城市的重要灾害、事故、突发事件的处理已达到5000起。通过系统对接和数据挖掘找到隐藏的待改进地方已达到8000多处。极大的提升了该市的政府办公效率，并得到了该市领导的一致好评。我会继续努力总结此项目中的不足和不完美之处，争取为社会做贡献，为祖国的建设添砖加瓦，共建美好未来。
