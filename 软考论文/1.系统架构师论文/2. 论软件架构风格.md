&emsp;2018年2月，我参加了某市智慧城市平台项目的研发，该项目的主要目的是经过多种渠道获取该市各种突发事件和各部门数据；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高办公效率。我在项目中承担架构设计师的职务，主要负责系统的技术选型和架构设计。
&emsp;本文以智慧应急系统为例，主要讨论软件架构风格在该项目中的具体应用。整体架构风格我们采用微服务风格，底层架构风格我们采用虚拟机风格中的解释器，因为该市上报的紧急事件类型能细分到上千种，对事件的分类以及处理流程是经常变动的而且流程通常很复杂，均通过自定义拖拽的方式进行组织，使用解释器风格可以满足各种事件处理流程的自定义；中间层关于数据的流转我们采用了独立构件风格中的隐式调用，这种风格主要用于降低系统间的耦合度、简化软件架构，提高可修改性方面的架构属性；系统应用层我们采用B/S的架构风格，为推广实施和维护提供了便捷。最终项目成功上线得到市领导的一致好评。
&emsp;随着互联网的崛起，某市响应政府的政策和号召，为了解决该城市中突发事件汇报不及时、上呈下达效率慢时间长、流程繁琐以及该市建设中不合理的隐匿问题以便更好的为人民服务；参考国外智能化城市建设的优势，决定发起智慧城市的项目。2018年1月，我司竞标该项目成功并承担了该市智慧城市项目的开发工作。该项目的主要目的是经过多种渠道获取该市各种事件信息（安保事故、消防事故、交通事故、地震、洪涝灾害等突发事件）和数据（主要是政府各职能部门如林业局，公安局，消防大队，具体涉及高铁、机场、林场、水库、公交、红绿灯、摄像头等相关设备的数据）；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高政府办公的速度，更快速更高效的解决突发事件。我在项目中担任架构设计师职务，架构小组共4人，我主要负责整体架构设计和中间件选型，3月份完成架构工作，整个项目历时10个月，2018年12月顺利通过验收。
&emsp;**在架构开始阶段我们就意识到，架构风格是一组设计原则，是能够提供抽象框架模式，可以为我们的项目提供通用解决方案的，这种能够极大提高软件设计的重用的方法能加快我们的建设进程**，因此在我司总工程师的建议下，我们使用了微服务架构风格、虚拟机风格、独立构件风格以及B/S风格。因该系统异常庞大、需求繁杂、模块间联系错综复杂，不易维护、迭代和部署，因此整体选择微服务架构风格进行分而治之来解决这些问题。虚拟机风格中的解释器风格能够提供灵活的解析引擎，这类风格非常适合复杂的自定义处理流程。独立构件风格包括进程通信风格与隐式调用风格，我们为了简化架构复杂度采用了隐式调用风格，通过消息订阅和发布控制系统间的信息交互，不仅能降低系统耦合度，而且还提高了架构的可修改性和稳定性。B/S架构风格是基于浏览器和服务器的软件架构，它主要使用HTTP协议进行通信和交互，简化客户端的工作，最终降低了系统推广和维护的难度，以下正文将重点描述架构风格的实施过程和效果。
&emsp;整体架构我们采用微服务架构风格来满足系统的稳定性、可扩展性需求。由于该系统模块很多，功能复杂，调用链很长，非常适合微服务架构风格来降低架构、维护、扩展以及部署的难度。微服务采用分而治之的策略将系统拆分为多个小的服务，如将系统拆分为上报服务、网格员服务、部委前置服务、指挥调度中心服务等。针对不同类型的服务对质量属性的要求制定副本的数量并可以动态扩展以应对突发流量。针对不同服务的业务特性利用微服务的异构组件选择不同的实现语言以及技术框架，方便不同程序员的开发协作以及服务间的交互。不同的服务由不同的小组负责，方便了单独开发，单独测试，独立部署。而且一个模块的故障不会导致整个系统瘫痪，增加了系统稳定性。不足之处在于使用微服务导致系统的复杂性增加，通过链路追踪虽然减轻了查错的难度但依然比直接DEBUG复杂。另外还需保证每个服务是无状态的（例如增加session共享机制）。除此之外对重要业务例如指令下发要使用分布式事务保证一致性以及还要实现分布式锁来解决分布式资源并发问题等，都带来了挑战。
&emsp;底层架构使用解释器风格来满足复杂处理流程的自定义需求。解释器风格是虚拟机风格中的一种，具有良好的灵活性。在本项目的指挥调度中心服务中需要将各种突发事件根据标签属性进行不同的自定义流程处理，事件有上千种，封装的事件处理组件有几十种；公务员通过界面拖拽组件和连接自定义处理流程，以对指定标签类型事件进行处理。流程可以保存为模板。一般来说这种软件编写难度大，维护压力也大，经分析后采用解释器风格。软件设计需要高度抽象、流程及模板的组织由配置文件来承担。具体做法如下，我们队对各个组件以及连接的数据结构进行高度抽象，每种组件都有对应的组件类型拖拽到流程后会生成对应的ID属性；组件间连接类型可以下拉选择内存队列或消息队列实现，拖拽并保存生效后会创建对应的队列并生成对应的唯一标识。保存生效或另存为模板后都会持久化到不同命令格式的XML文件中。另外需要搭建一套专门用于解释流程和模板的解释器，在保存或项目启动时由解释引擎读取对应文件夹下的所有XML文件并通过Java反射机制动态生成JAVA对象以及检测或创建对应的队列。将复杂的自定义流程简单化。如果现有组件可以满足新的处理需求，那么创建新的事件标签以及拖拽组件生成需要的处理流程即可。如果不满足只需要按照组件的开发约定开发新的组件再进行编排即可。这种风格的实现将复杂的处理流程简单化，而且提升了可修改性并规避了流程的频繁变动带来的风险性。
&emsp;中间层我们使用独立构件中的隐式调用风格来简化构件间的交互复杂度，降低系统耦合度。主要实现手段是，我们采用了一个SpringCloud Stream组件加kafka实现。kafka是完全分布式的消息中间件，不仅有各种机制保证消息的不丢失，还具有分区以及对应多副本的主从读写以及分布式部署功能，不论是从吞吐量、高可用、高扩展方面都是非常优异的。前面提到指挥调度系统不仅需要接收上报服务以及网格员服务发送的事件还要接收来各职能部门对应部委前置服务的数据，消息交互复杂。使用消息中间件基于发布订阅方式实现事件和数据的流转，解耦前面服务和指挥中心并利用异步特性提升了系统的整体性能。之所以采用Stream组件而不直接使用kafka的API，原因之一是采用统一的input、output信道以及绑定器可以与具体的中间件解耦来提升可修改性，其次是Stream还提供了额外增强功能如消费组、消息分区等功能使开发更方便。整体来说采用此风格大大降低了二次开发和维护的难度。
&emsp;应用系统层我们采用B/S的架构风格，主要用于解决客户端升级困难以及新旧客户端并存带来的升级问题。也是现代软件系统最常用的一种方式，除了上报系统有一个渠道是采用小程序外，其它每个系统的前端都是采用H5加websocket技术实现。虽然在前端在渲染方面上不如安装的客户端，但在用户体验和维护升级方面远远高于C/S。
&emsp;项目于2018年12月完成验收，至今已稳定运行两年的时间，并未出现大的故障，在高峰时期数据流量能达到百万级别。并得到该市领导的一致表扬。其不足之处有两点：第一在架构设计过程中我们忽略了PC配置，个别PC因为需要兼容老的应用软件不允许升级，这些电脑系统版本老旧，其浏览器不支持H5导致了推广障碍，我们最后通过说服客户采购新的PC得以解决。第二是系统容灾方面有待改善，在运行期间由于施工单位挖断电缆导致系统无法访问，最后为了避免同样情况发生决定采用异地多机房来进行解决。通过此项目使我受益匪浅，我会继续努力提升自己的架构水平，提升自己的个人价值和社会价值，为祖国建设添砖加瓦。
