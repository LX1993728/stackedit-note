&emsp;2018年2月，我参加了某市智慧城市平台项目的研发，该项目的主要目的是经过多种渠道获取该市各种突发事件和各部门数据；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高办公效率。我在项目中承担架构设计师的职务，主要负责系统的技术选型、架构设计以及部分软件设计工作。本文以其中的智慧应急系统为例，介绍软件容错技术在项目中的应用。在应用服务层采用集群技术来容错，在数据库层通过主从部署来容错，在代码层面通过程序设计来容错。事实证明，以上软件容错技术和方法在该系统中的具体应用对于系统的可用性、安全性、扩展性方面都起到了很好的效果，满足了该系统的性能需求，并且该平台从上线到目前一直稳定运行，得到客户和各级领导的一致赞赏。
&emsp;随着互联网的崛起，某市响应政府的政策和号召，为了解决该城市中突发事件汇报不及时、上呈下达效率慢时间长、流程繁琐以及该市建设中不合理的隐匿问题以便更好的为人民服务；参考国外智能化城市建设的优势，决定发起智慧城市的项目。2018年2月，我司竞标该项目成功并承担了该市智慧城市项目的开发工作。该项目的主要目的是经过多种渠道获取该市各种事件信息（安保事故、消防事故、交通事故、地震、洪涝灾害等突发事件）和数据（主要是政府各职能部门如林业局，公安局，消防大队，具体涉及高铁、机场、林场、水库、公交、红绿灯、摄像头等相关设备的数据）；通过对事件的紧急处理和数据的分析产生出决策并下发指令以提高政府办公的速度，更快速更高效的解决突发事件。我在项目中担任架构设计师职务，架构小组共4人，我主要负责整体架构设计和部分软件设计，整个项目历时10个月，2018年12月顺利通过验收。
&emsp;指挥应急系统采用的核心架构风格为微服务的架构风格，采用Java作为核心开发语言，将系统服务分成了三类，即web服务、核心服务、保障服务。其中核心服务按业务功能分为网格员服务、部委前置服务、指挥调度服务等等。平台web服务主要提供与用户交互的界面。平台保障服务包括分布式任务调度服务，业务和运行监控服务，注册中心服务，中间件服务等。对这些服务中的核心服务，web服务相关的服务必须要满足`7*24`小时稳定运行，对软件的可靠性要去非常高，所以该系统中的这些核心服务就必须具备一定的容错能力，在某个服务运行时出错的情况下不能影响到整个集群中的服务，这就要求在软件架构设计中必须考虑到软件容错技术的应用。
&emsp;提高软件系统可靠性技术主要分为容错和避错技术，容错技术的主要方式是冗余，冗余分为结构冗余、信息冗余、时间冗余和冗余附加。结构冗余又分为静态冗余、动态冗余和混合冗余。软件容错技术主要有N版本程序设计，恢复块方法，和防卫式程序设计。结合软件产品的特性，我主要采用了集群技术、数据库主从方式、和程序设计方面来进行软件的容错和避错处理。下面就从三个方面介绍我所采用的容错技术和方法。
&emsp;**1、通过集群技术来容错**
&emsp;平台中的各服务如果运行时部署在一台服务器上，那么当服务器发生故障时，整个平台将不会提供任何服务。所以一般非常小规模的应用才会采取这样的部署方式，像互联网应用这样的智慧应急系统来说必须采用多机同时部署的方式，防止单台机器宕机或服务进程Crash导致整个系统不能提供服务的问题。通过多机同时部署，当一台机器上的某个服务出现故障或机器宕机导致该机器上的所有服务挂掉时，微服务中的注册中心会根据心跳内容和超时时间自动剔除故障的服务而且可以动态发现新的服务并将其加入进来。配合服务客户端的软负载均衡机制可以轻松的实现发生故障时的平滑过渡，达到容错的目的。另外平台各服务首次获取到静态数据时会将其存入到分布式缓存中，例如采用RedisCluster技术，可以很好的保证写入缓存中的数据获取的高可靠性，恰当的使用缓存不但会提升平台性能，同时还可以起到容错的效果，例如某个服务所依赖的后端存储发生了短暂的故障或网络抖动，在这个时候大量的并发请求发现缓存中有需要的内容则直接将缓存中获取的数据返回给调用方，起到很好的容错效果。
&emsp;**2、通过数据库主从部署方式来容错**
&emsp;对该系统来说，所依赖的后端数据库存储的稳定性是非常重要的，所有的上报事件、工作汇报、分析结果都将直接存储到数据库中。如果数据库在运行过程中频繁宕机，那么带来的后果是非常严重的，因为会造成上报事件丢失，事故灾情等无法及时送达等问题。所以在这里就要求数据库存储具有非常高的可靠性，同时具有很强的容错性，在这里我主要采用数据库部署结构为主从方式，要求部署在不同服务器上。在不出现问题的情况下对于一些时效性要求不是很高的场合从库可以负责承担一部分的流量，当主库发生读写问题时，可快速由其他的从库升级为主库，继续服务，达到容错的效果。在这里我还要求数据库宕机加报警的方式来防止宕机的主从数据库实例过多，导致在并发高的情况下没有可用的从库升级为主库来提供服务，通过这样的方式也提高了整个平台的高可靠性。在数据库数据文件存储方面我也要求采用RAID5冗余磁盘阵列技术来防止单块磁盘损坏导致的数据文件丢失问题。
&emsp;**3、通过程序设计方面进行软件的容错**
&emsp;根据以往的架构经验，对于系统的不可靠大部分是由于程序内部的设计或者网络请求参数的配置或者连接池以及线程池参数配置不当所导致的。所以通过程序设计方面进行进软件的容错是非常重要的。在程序设计方面的容错用的最普遍的就是防卫式程序设计。我提出该项目中的防卫式程序设计的相关策略包括RPC容错，资源隔离。其中资源隔离的方式有舱壁隔离、泳道技术和短路技术。1、RPC容错：例如服务间进行RPC调用时设计各种容错机制。常见的RPC容错有失败重试，快速失败，失败安全，失败自动恢复等机制用于不同业务场景下的失败处理策略；如失败重试适用于读操作或具备幂等性设计的写操作，在网络抖动或丢包的情况下进行容错。2、短路器：之所以引入短路器技术，是为了在出现故障后的一段时间直接服务降级并返回默认的错误值，以防调用方设置的超时时间过长造成线程阻塞导致进程中的资源无法释放从而引起服务雪崩的故障。3、舱壁隔离：所谓的舱壁隔离技术就是基于IO请求并发量或者线程池线程数对调用非常频繁的功能进行资源限制，以防止某个功能并发过高耗尽进程的资源而造成服务进程崩溃。
&emsp;通过采用了以上容错技术的方法和措施后，平台从线上运行到目前为止，各服务运行状态良好。通过监控和日志来看，从未出现功能失效的情况，得到了客户和高层领导的一致赞赏。但我看来还有不足之处。即各服务之间对于事务一致性问题的容错处理。针对该问题，目前只能保证事务的最终一致性，因为根据CAP理论，要解决该问题有一定的难度。后续准备使用TCC的事务处理方式来应对紧急事件的处理来保证时效性。
&emsp;软件容错技术对软件的稳定性起着至关重要的作用，尤其是针对高并发的场景，软件容错技术应用的重要性就不言而喻了。经过我这次所采用的的软件容错技术的方法和措施实施后，是我也看到了自身的不足之处，我会在今后的架构设计过程中不断更新自己的知识，不断完善自己的架构设计领域，设计出更好的软件架构，更好的支撑业务平台的运行，为公司为社会尽一份绵薄之力。
